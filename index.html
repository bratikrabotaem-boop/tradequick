<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>BTC Pro Sim</title>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
/* ===== 1. ОСНОВНОЙ СТИЛЬ (Layout) ===== */
body {
    margin: 0;
    background: #121417;
    color: #e6e6e6;
    font-family: -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif;
    /* Разрешаем обычный скролл страницы */
    overflow-y: scroll; 
    -webkit-overflow-scrolling: touch;
    padding-bottom: 40px; /* Отступ снизу для удобства */
}

.wrapper {
    max-width: 800px;
    margin: 0 auto;
    padding: 15px;
}

/* ===== 2. ШАПКА ===== */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.title { font-size: 18px; font-weight: 800; color: #fff; }
.sub { font-size: 12px; color: #6b7280; margin-top: 2px; }

.tf-buttons {
    background: #1e2228;
    padding: 2px;
    border-radius: 8px;
    display: flex;
    gap: 2px;
}
.tf-buttons button {
    background: transparent;
    border: 0;
    color: #888;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
}
.tf-buttons button.active {
    background: #363a45;
    color: #fff;
}

/* ===== 3. ГРАФИКИ (Фиксированная высота) ===== */
#price {
    width: 100%;
    height: 380px; /* Фиксированная высота */
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 10px;
}
#volume {
    width: 100%;
    height: 100px; /* Фиксированная высота */
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 20px;
}

/* ===== 4. ПАНЕЛЬ ТОРГОВЛИ (Крупная и удобная) ===== */
.trade-panel {
    background: #1e2228;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.stats-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    padding: 0 10px;
}

.stat-box { display: flex; flex-direction: column; }
.stat-label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: 600; }
.stat-val { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }

/* Цвета для PnL */
.pnl-pos { color: #1fc77b; }
.pnl-neg { color: #e04b4b; }
.pnl-neu { color: #fff; }

/* Кнопки */
.buttons-row {
    display: flex;
    gap: 12px;
}

.btn {
    flex: 1;
    height: 56px; /* Большие кнопки под палец */
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 800;
    color: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.1s, opacity 0.2s;
}
.btn:active { transform: scale(0.97); opacity: 0.9; }

.btn-long { background: #1fc77b; }
.btn-short { background: #e04b4b; }
.btn-close { background: #4b5563; color: #fff; border: 1px solid #6b7280; }

.btn:disabled {
    opacity: 0.4;
    background: #2a2d33 !important;
    color: #888 !important;
    cursor: not-allowed;
}

.reset-container {
    margin-top: 15px;
    text-align: center;
    display: none; /* Скрыто по умолчанию */
}
.btn-reset {
    background: transparent;
    border: 1px solid #374151;
    color: #9ca3af;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
}

</style>
</head>

<body>

<div class="wrapper">
    <header>
        <div>
            <div class="title">BTC/USDT</div>
            <div class="sub">x150 Leverage • Realtime</div>
        </div>
        <div class="tf-buttons">
            <button onclick="setTF('15m')">15M</button>
            <button onclick="setTF('5m')">5M</button>
            <button onclick="setTF('1m')" class="active">1M</button>
        </div>
    </header>

    <div id="price"></div>
    <div id="volume"></div>

    <div class="trade-panel">
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-label">Balance (USDT)</span>
                <span class="stat-val" id="ui-bal">10.00</span>
            </div>
            <div class="stat-box" style="align-items: flex-end;">
                <span class="stat-label">PnL</span>
                <span class="stat-val pnl-neu" id="ui-pnl">0.00</span>
            </div>
        </div>

        <div class="buttons-row" id="action-area">
            </div>

        <div class="reset-container" id="reset-area">
            <button class="btn-reset" onclick="resetGame()">Reset Balance</button>
        </div>
    </div>
</div>

<script>
/* ==========================================
   1. НАСТРОЙКИ И УТИЛИТЫ
   ========================================== */
// Блокируем системный зум iOS, но оставляем скролл
document.addEventListener('gesturestart', function(e) { e.preventDefault(); });

let INTERVAL = '1m';
let ws = null;
let sessionId = 0;
let lastPrice = 0;

/* ==========================================
   2. ГРАФИКИ (CONFIG)
   ========================================== */
const chartConfig = {
    layout: { background: { color: '#121417' }, textColor: '#9ca3af' },
    grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } },
    timeScale: { 
        timeVisible: true, 
        secondsVisible: false, 
        borderColor: '#1f2937',
        rightOffset: 5 
    },
    // !!! ГЛАВНОЕ ИСПРАВЛЕНИЕ СКРОЛЛА !!!
    handleScroll: {
        vertTouchDrag: false, // FALSE = страница скроллится пальцем
        horzTouchDrag: true,  // TRUE = график можно двигать влево-вправо
    },
    handleScale: {
        pinch: true, // Зум двумя пальцами разрешен
        axisPressedMouseMove: false, // Отключаем зум по шкале (чтобы не сбивать)
    }
};

// --- PRICE CHART ---
const priceChart = LightweightCharts.createChart(document.getElementById('price'), chartConfig);
const candles = priceChart.addCandlestickSeries({
    upColor: '#1fc77b', downColor: '#e04b4b',
    borderUpColor: '#1fc77b', borderDownColor: '#e04b4b',
    wickUpColor: '#1fc77b', wickDownColor: '#e04b4b'
});

// --- VOLUME CHART ---
const volConfig = { ...chartConfig };
// Для объема отключаем зум вообще, чтобы случайно не задеть
volConfig.handleScale = { pinch: false, axisPressedMouseMove: false, mouseWheel: false };

const volumeChart = LightweightCharts.createChart(document.getElementById('volume'), volConfig);
const volumeSeries = volumeChart.addHistogramSeries({
    base: 0, priceFormat: { type: 'volume' }
});

// Синхронизация движения (влево-вправо)
function syncCharts(a, b) {
    let isSyncing = false;
    a.timeScale().subscribeVisibleLogicalRangeChange(range => {
        if(!isSyncing && range) {
            isSyncing = true;
            b.timeScale().setVisibleLogicalRange(range);
            isSyncing = false;
        }
    });
}
syncCharts(priceChart, volumeChart);
syncCharts(volumeChart, priceChart);

// Авто-ресайз (чтобы не было белых полос)
new ResizeObserver(entries => {
    const r = entries[0].contentRect;
    priceChart.resize(r.width, 380); // Держим высоту жесткой
}).observe(document.getElementById('price'));

new ResizeObserver(entries => {
    const r = entries[0].contentRect;
    volumeChart.resize(r.width, 100);
}).observe(document.getElementById('volume'));


/* ==========================================
   3. ДАННЫЕ (API + WS)
   ========================================== */
async function loadData() {
    sessionId++;
    const currentSess = sessionId;
    if(ws) { ws.close(); ws = null; }

    try {
        const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${INTERVAL}&limit=200`);
        const data = await r.json();

        const cData = [];
        const vData = [];
        
        data.forEach(k => {
            const t = k[0]/1000;
            const o=+k[1], h=+k[2], l=+k[3], c=+k[4];
            cData.push({ time:t, open:o, high:h, low:l, close:c });
            
            // Расчет Net Volume
            const buyVol = +k[10]; // Taker buy base asset volume
            const totalVol = +k[7]; // Quote asset volume (примерно) или используем k[5] volume
            // Упрощенная формула дельты для визуализации
            const net = (2 * (+k[10]) - (+k[7])); 
            
            vData.push({ 
                time:t, 
                value: net, 
                color: net >= 0 ? '#1fc77b' : '#e04b4b' 
            });
        });

        if(cData.length) lastPrice = cData[cData.length-1].close;

        candles.setData(cData);
        volumeSeries.setData(vData);
        priceChart.timeScale().fitContent();

        // Запуск сокета
        ws = new WebSocket(`wss://stream.binance.com:9443/ws/btcusdt@kline_${INTERVAL}`);
        ws.onmessage = e => {
            if(currentSess !== sessionId) return;
            const msg = JSON.parse(e.data);
            const k = msg.k;
            const t = Math.floor(k.t/1000);
            const c = +k.c;
            lastPrice = c;

            candles.update({ time:t, open:+k.o, high:+k.h, low:+k.l, close:c });
            
            const net = (2 * (+k.Q) - (+k.q)); // Используем Quote volume для дельты
            volumeSeries.update({ time:t, value:net, color: net>=0?'#1fc77b':'#e04b4b' });

            updatePnL(); // Обновляем цифры PnL каждую секунду
        };

    } catch(err) {
        console.log(err);
        alert("Ошибка загрузки данных");
    }
}

function setTF(tf) {
    if(INTERVAL === tf) return;
    INTERVAL = tf;
    document.querySelectorAll('.tf-buttons button').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    loadData();
}

/* ==========================================
   4. ТОРГОВАЯ ЛОГИКА (Engine)
   ========================================== */
let balance = 10.00;
const LEVERAGE = 150;
let position = null; // { side: 'long'|'short', entry: 0, notional: 0, lines: [] }

// DOM Элементы
const elBal = document.getElementById('ui-bal');
const elPnl = document.getElementById('ui-pnl');
const elActions = document.getElementById('action-area');
const elReset = document.getElementById('reset-area');

// 1. ОТКРЫТИЕ ПОЗИЦИИ
function openPos(side) {
    if(position || balance < 1) return;

    const entry = lastPrice;
    const margin = balance; // Входим на всю котлету
    const notional = margin * LEVERAGE;
    
    // Считаем Ликвидацию
    // Long: entry - (entry / lev) * 0.95 (чуть раньше нуля)
    let liq = 0;
    if(side === 'long') liq = entry * (1 - 1/LEVERAGE);
    else liq = entry * (1 + 1/LEVERAGE);

    position = {
        side: side,
        entry: entry,
        margin: margin,
        notional: notional,
        liq: liq,
        lines: []
    };

    // Рисуем линии
    // Линия входа (Зеленая пунктирная)
    const lineEntry = priceChart.addPriceLine({
        price: entry,
        color: '#1fc77b',
        lineWidth: 2,
        lineStyle: LightweightCharts.LineStyle.Dotted,
        axisLabelVisible: true,
        title: 'ENTRY'
    });
    
    // Линия Ликвидации (Красная пунктирная)
    const lineLiq = priceChart.addPriceLine({
        price: liq,
        color: '#e04b4b',
        lineWidth: 2,
        lineStyle: LightweightCharts.LineStyle.Dotted,
        axisLabelVisible: true,
        title: 'LIQ'
    });

    position.lines.push(lineEntry, lineLiq);

    renderUI();
}

// 2. ЗАКРЫТИЕ ПОЗИЦИИ (Фиксация прибыли)
function closePos() {
    if(!position) return;

    // Считаем финальный PnL
    const finalPnL = calculatePnLValue();
    
    // Обновляем баланс
    balance = balance + finalPnL;
    if(balance < 0) balance = 0;

    // Чистим всё
    removePositionLines();
    position = null;
    
    // Обновляем UI
    elBal.textContent = balance.toFixed(2);
    elPnl.textContent = "0.00";
    elPnl.className = "stat-val pnl-neu";
    
    renderUI();
}

// 3. РАСЧЕТ PNL (МАТЕМАТИКА)
function calculatePnLValue() {
    if(!position) return 0;
    const priceDiff = (lastPrice - position.entry) / position.entry;
    
    let pnl = 0;
    if(position.side === 'long') {
        pnl = position.notional * priceDiff;
    } else {
        pnl = position.notional * (-priceDiff);
    }
    return pnl;
}

// 4. ОБНОВЛЕНИЕ В РЕАЛЬНОМ ВРЕМЕНИ (LOOP)
function updatePnL() {
    if(!position) return;

    const pnl = calculatePnLValue();
    const equity = balance + pnl;

    // Визуал PnL
    elPnl.textContent = (pnl > 0 ? "+" : "") + pnl.toFixed(2);
    if(pnl > 0) elPnl.className = "stat-val pnl-pos";
    else if(pnl < 0) elPnl.className = "stat-val pnl-neg";
    else elPnl.className = "stat-val pnl-neu";

    // Проверка ликвидации
    let isDead = false;
    if(position.side === 'long' && lastPrice <= position.liq) isDead = true;
    if(position.side === 'short' && lastPrice >= position.liq) isDead = true;

    // Если баланс ушел в ноль
    if(isDead || equity <= 0) {
        alert("LIQUIDATED!");
        balance = 0;
        removePositionLines();
        position = null;
        elBal.textContent = "0.00";
        elPnl.textContent = "0.00";
        renderUI();
    }
}

function removePositionLines() {
    if(position && position.lines) {
        position.lines.forEach(l => priceChart.removePriceLine(l));
    }
}

// 5. ОТРИСОВКА КНОПОК
function renderUI() {
    // Если баланс слит
    if(balance < 1 && !position) {
        elActions.innerHTML = `<button class="btn" disabled>GAME OVER</button>`;
        elReset.style.display = 'block';
        return;
    }
    elReset.style.display = 'none';

    // Если нет позиции -> Кнопки Buy/Sell
    if(!position) {
        elActions.innerHTML = `
            <button class="btn btn-long" onclick="openPos('long')">LONG</button>
            <button class="btn btn-short" onclick="openPos('short')">SHORT</button>
        `;
    } 
    // Если LONG -> Кнопка Sell становится CLOSE
    else if(position.side === 'long') {
        elActions.innerHTML = `
            <button class="btn" disabled style="font-size:12px;">ENTRY<br>${position.entry.toFixed(1)}</button>
            <button class="btn btn-short" onclick="closePos()">CLOSE LONG</button>
        `;
    }
    // Если SHORT -> Кнопка Buy становится CLOSE
    else {
        elActions.innerHTML = `
            <button class="btn btn-long" onclick="closePos()">CLOSE SHORT</button>
            <button class="btn" disabled style="font-size:12px;">ENTRY<br>${position.entry.toFixed(1)}</button>
        `;
    }
}

function resetGame() {
    balance = 10.00;
    elBal.textContent = "10.00";
    renderUI();
}

// Старт
loadData();
renderUI();

</script>
</body>
</html>
