<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>BTC-USDT · Net Volume (Realtime Fixed)</title>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {
  margin:0;
  background:#121417;
  color:#e6e6e6;
  font-family:Arial,sans-serif;
}
.wrapper {
  max-width:1100px;
  margin:20px auto;
  padding:0 10px;
}
.title { text-align:center; font-size:18px; }
.sub { text-align:center; font-size:13px; color:#8a8a8a; margin-bottom:8px; }

.tf-buttons {
  display:flex;
  justify-content:center;
  gap:8px;
  margin-bottom:8px;
}
.tf-buttons button {
  background:#2a2d33;
  border:0;
  color:#ccc;
  padding:5px 10px;
  border-radius:4px;
  font-size:12px;
  cursor:pointer;
}
.tf-buttons button.active {
  background:#3f434b;
  color:#fff;
}

#price,#volume { width:100%; touch-action:none }
#price { height:420px }
#volume { height:140px }

/* ===== TRADE PANEL ===== */
.trade{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:14px;
  margin-top:10px;
}
.trade button{
  width:72px;
  padding:6px 0;
  border:0;
  border-radius:4px;
  font-weight:600;
}
.buy{ background:#1fc77b; color:#000 }
.sell{ background:#e04b4b; color:#000 }
#bal{
  min-width:90px;
  text-align:center;
  font-weight:600;
}
</style>
</head>

<body>
<div class="wrapper">
  <div class="title">BTC-USDT · NET VOLUME</div>
  <div class="sub">BINANCE · REALTIME (USDT)</div>

  <div class="tf-buttons">
    <button onclick="setTF('15m')">15M</button>
    <button onclick="setTF('5m')">5M</button>
    <button onclick="setTF('1m')" class="active">1M</button>
  </div>

  <div id="price"></div>
  <div id="volume"></div>

  <div class="trade">
    <button class="buy" onclick="openPos('long')">BUY</button>
    <div id="bal">10.00</div>
    <button class="sell" onclick="openPos('short')">SELL</button>
  </div>
</div>

<script>
['gesturestart','gesturechange','gestureend'].forEach(e=>{
  document.addEventListener(e,ev=>ev.preventDefault(),{passive:false});
});

function formatTimeNoSeconds(time){
  const d=new Date(time*1000);
  return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'short',year:'2-digit'})
    +' '+String(d.getHours()).padStart(2,'0')
    +':'+String(d.getMinutes()).padStart(2,'0');
}

let INTERVAL='1m', ws=null, sessionId=0;

/* ===== CHARTS ===== */
const commonOpts={
  layout:{background:{color:'#121417'},textColor:'#ccc'},
  grid:{vertLines:{color:'#1e2228'},horzLines:{color:'#1e2228'}},
  localization:{timeFormatter:formatTimeNoSeconds},
  timeScale:{timeVisible:true,secondsVisible:false}
};

const priceChart=LightweightCharts.createChart(
  document.getElementById('price'),
  {...commonOpts,rightPriceScale:{visible:false},leftPriceScale:{visible:false}}
);

const candles=priceChart.addCandlestickSeries({
  upColor:'#1fc77b',downColor:'#e04b4b',
  borderUpColor:'#1fc77b',borderDownColor:'#e04b4b',
  wickUpColor:'#1fc77b',wickDownColor:'#e04b4b'
});

const volumeChart=LightweightCharts.createChart(
  document.getElementById('volume'),
  {...commonOpts,rightPriceScale:{visible:false},leftPriceScale:{visible:false}}
);

const volumeSeries=volumeChart.addHistogramSeries({base:0});

/* ===== DATA ===== */
async function loadData(){
  sessionId++;
  if(ws){ws.close();ws=null}

  const r=await fetch(
    `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${INTERVAL}&limit=500`
  );
  const d=await r.json();

  const c=[],v=[];
  d.forEach(k=>{
    const t=k[0]/1000;
    c.push({time:t,open:+k[1],high:+k[2],low:+k[3],close:+k[4]});
    const net=2*k[10]-k[7];
    v.push({time:t,value:net/1e6,color:net>=0?'#1fc77b':'#e04b4b'});
  });

  candles.setData(c);
  volumeSeries.setData(v);
  priceChart.timeScale().fitContent();

  startRealtime(sessionId);
}

function startRealtime(id){
  ws=new WebSocket(`wss://stream.binance.com:9443/ws/btcusdt@kline_${INTERVAL}`);
  ws.onmessage=e=>{
    if(id!==sessionId) return;
    const k=JSON.parse(e.data).k;
    const time=Math.floor(k.t/1000);

    candles.update({
      time,open:+k.o,high:+k.h,low:+k.l,close:+k.c
    });

    const net=2*+k.Q-+k.q;
    volumeSeries.update({
      time,value:net/1e6,color:net>=0?'#1fc77b':'#e04b4b'
    });

    if(position){
      const price=+k.c;
      const pnl=position.side==='long'
        ? (price-position.entry)/position.entry*NOTIONAL
        : (position.entry-price)/position.entry*NOTIONAL;

      bal.textContent=(balance+pnl).toFixed(2);

      if(
        (position.side==='long' && price<=position.liq) ||
        (position.side==='short' && price>=position.liq)
      ){
        closePos(balance-10);
      }
    }
  };
}

function setTF(tf){
  INTERVAL=tf;
  document.querySelectorAll('.tf-buttons button')
    .forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  loadData();
}

/* ===== DEMO TRADING ===== */
let balance=10;
let position=null;
const DEPOSIT=10, LEVERAGE=150, NOTIONAL=1500;
const bal=document.getElementById('bal');

function openPos(side){
  const price=candles._data.at(-1).close;

  if(position){
    if(position.side===side) return;

    const pnl=position.side==='long'
      ? (price-position.entry)/position.entry*NOTIONAL
      : (position.entry-price)/position.entry*NOTIONAL;

    closePos(balance+pnl);
    return;
  }

  if(balance<DEPOSIT) return;

  const liq=side==='long'
    ? price*(1-1/LEVERAGE)
    : price*(1+1/LEVERAGE);

  position={
    side,entry:price,liq,
    lineEntry:priceChart.addPriceLine({
      price,color:'#1fc77b',
      lineStyle:LightweightCharts.LineStyle.Dotted,title:'Позиция'
    }),
    lineLiq:priceChart.addPriceLine({
      price:liq,color:'#e04b4b',
      lineStyle:LightweightCharts.LineStyle.Dotted,title:'Ликвидация'
    })
  };
}

function closePos(newBalance){
  priceChart.removePriceLine(position.lineEntry);
  priceChart.removePriceLine(position.lineLiq);
  balance=Math.max(0,newBalance);
  position=null;
  bal.textContent=balance.toFixed(2);
}

loadData();
</script>
</body>
</html>
