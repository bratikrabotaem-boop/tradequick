<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Chaos Trading Sim</title>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
/* ===== 1. ОСНОВНОЙ СТИЛЬ ===== */
body {
    margin: 0;
    background: #121417;
    color: #e6e6e6;
    font-family: -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif;
    overflow-y: hidden; /* Блокируем скролл всей страницы, всё помещается на экран */
    height: 100vh;
    display: flex;
    flex-direction: column;
}

.wrapper {
    max-width: 800px;
    margin: 0 auto;
    padding: 10px;
    width: 100%;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    height: 100%;
}

/* ===== 2. ШАПКА ===== */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-shrink: 0;
}
.title { font-size: 18px; font-weight: 800; color: #fff; }
.sub { font-size: 12px; color: #6b7280; margin-top: 2px; }
.live-badge { 
    background: #1fc77b; color: #000; padding: 2px 6px; 
    border-radius: 4px; font-size: 10px; font-weight: 700; vertical-align: middle;
}

/* ===== 3. ГРАФИК (Теперь один и большой) ===== */
#chart-area {
    flex: 1; /* Занимает всё свободное место */
    width: 100%;
    min-height: 0; /* Важно для flex контейнера */
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    margin-bottom: 15px;
    border: 1px solid #1f2937;
}
#price {
    width: 100%;
    height: 100%;
}

/* ===== 4. ПАНЕЛЬ ТОРГОВЛИ (Сохранили дизайн) ===== */
.trade-panel {
    background: #1e2228;
    border-radius: 16px;
    padding: 15px 20px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    flex-shrink: 0; /* Не сжимается */
}

.stats-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
}

.stat-box { display: flex; flex-direction: column; }
.stat-label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: 600; }
.stat-val { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; font-variant-numeric: tabular-nums; }

.pnl-pos { color: #1fc77b; }
.pnl-neg { color: #e04b4b; }
.pnl-neu { color: #fff; }

.buttons-row { display: flex; gap: 12px; }

.btn {
    flex: 1;
    height: 54px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 800;
    color: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.1s, opacity 0.2s;
    cursor: pointer;
    text-transform: uppercase;
}
.btn:active { transform: scale(0.96); opacity: 0.9; }

.btn-long { background: #1fc77b; box-shadow: 0 4px 12px rgba(31, 199, 123, 0.2); }
.btn-short { background: #e04b4b; box-shadow: 0 4px 12px rgba(224, 75, 75, 0.2); }
.btn-close { background: #4b5563; color: #fff; border: 1px solid #6b7280; }

.btn:disabled {
    opacity: 0.5;
    background: #2a2d33 !important;
    color: #888 !important;
    box-shadow: none;
    cursor: not-allowed;
}

/* Кнопка сброса (если слил депозит) */
.reset-overlay {
    position: absolute; top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.8);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.btn-restart {
    padding: 15px 30px;
    background: #fff; color: #000;
    border: 0; border-radius: 30px;
    font-weight: 700; font-size: 18px;
    cursor: pointer;
}

</style>
</head>

<body>

<div class="wrapper">
    <header>
        <div>
            <div class="title">BTC/USDT <span class="live-badge">SIMULATOR</span></div>
            <div class="sub">High Volatility • Random Walk</div>
        </div>
    </header>

    <div id="chart-area">
        <div id="price"></div>
        <div class="reset-overlay" id="reset-screen">
            <h2 style="color:#e04b4b; margin-bottom:20px;">LIQUIDATED</h2>
            <button class="btn-restart" onclick="resetGame()">TRY AGAIN</button>
        </div>
    </div>

    <div class="trade-panel">
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-label">Balance (USDT)</span>
                <span class="stat-val" id="ui-bal">10.00</span>
            </div>
            <div class="stat-box" style="align-items: flex-end;">
                <span class="stat-label">PnL</span>
                <span class="stat-val pnl-neu" id="ui-pnl">0.00</span>
            </div>
        </div>

        <div class="buttons-row" id="action-area">
            </div>
    </div>
</div>

<script>
/* ==========================================
   1. НАСТРОЙКИ СИСТЕМЫ
   ========================================== */
// Отключаем зум iOS
document.addEventListener('gesturestart', function(e) { e.preventDefault(); });

/* ==========================================
   2. ГРАФИК
   ========================================== */
const chartContainer = document.getElementById('price');
const chart = LightweightCharts.createChart(chartContainer, {
    layout: { background: { color: '#121417' }, textColor: '#9ca3af' },
    grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } },
    timeScale: { 
        timeVisible: true, 
        secondsVisible: true,
        borderColor: '#1f2937',
    },
    crosshair: { mode: 0 }, // Free crosshair
    handleScroll: { vertTouchDrag: false, horzTouchDrag: true },
    handleScale: { pinch: true, axisPressedMouseMove: true },
});

const candleSeries = chart.addCandlestickSeries({
    upColor: '#1fc77b', downColor: '#e04b4b',
    borderUpColor: '#1fc77b', borderDownColor: '#e04b4b',
    wickUpColor: '#1fc77b', wickDownColor: '#e04b4b'
});

// Авто-ресайз
new ResizeObserver(entries => {
    const r = entries[0].contentRect;
    chart.resize(r.width, r.height);
}).observe(document.getElementById('chart-area'));

/* ==========================================
   3. ГЕНЕРАТОР ХАОСА (СИМУЛЯЦИЯ РЫНКА)
   ========================================== */
let currentPrice = 95000.00;
let lastTickTime = Date.now();
let currentCandle = null;
let candleInterval = 60 * 1000; // 1 минута свечи
let nextCandleTime = 0;

// Инициализация истории (чтобы график не был пустым)
function initHistory() {
    const data = [];
    let time = Math.floor(Date.now() / 1000) - (100 * 60); // 100 минут назад
    let price = currentPrice;

    for (let i = 0; i < 100; i++) {
        const open = price;
        // Генерируем случайную волатильность для истории
        const change = (Math.random() - 0.5) * 200; 
        const close = open + change;
        const high = Math.max(open, close) + Math.random() * 50;
        const low = Math.min(open, close) - Math.random() * 50;
        
        data.push({ time, open, high, low, close });
        price = close;
        time += 60;
    }
    
    currentPrice = price;
    candleSeries.setData(data);
    
    // Подготовка первой живой свечи
    nextCandleTime = (time + 60) * 1000;
    currentCandle = {
        time: time + 60,
        open: currentPrice,
        high: currentPrice,
        low: currentPrice,
        close: currentPrice
    };
}

// === СЕРДЦЕ СИМУЛЯЦИИ ===
// Функция вызывается каждые 100мс
let momentum = 0; // Инерция движения

function tick() {
    const now = Date.now();

    // 1. Смена свечи, если время пришло
    if (now >= nextCandleTime) {
        // Фиксируем текущую
        nextCandleTime = now + candleInterval;
        // Новая свеча
        const t = Math.floor(now / 1000);
        currentCandle = {
            time: t,
            open: currentPrice,
            high: currentPrice,
            low: currentPrice,
            close: currentPrice
        };
    }

    // 2. Расчет движения цены (Random Walk + Momentum)
    // Базовая волатильность
    let delta = (Math.random() - 0.5) * 30; // +/- 15 долларов за тик
    
    // Эффект "Толпы/Инерции": если цена шла вверх, она склонна продолжить
    momentum = momentum * 0.9 + delta * 0.1;
    
    // Случайные "Импульсы" (Крупные покупки/продажи)
    if(Math.random() < 0.05) { // 5% шанс на резкий рывок
        delta += (Math.random() - 0.5) * 150;
    }

    currentPrice += delta + momentum;

    // 3. Обновление свечи
    currentCandle.close = currentPrice;
    currentCandle.high = Math.max(currentCandle.high, currentPrice);
    currentCandle.low = Math.min(currentCandle.low, currentPrice);

    // 4. Отрисовка
    candleSeries.update(currentCandle);

    // 5. Просчет торговой логики
    updateTradingLogic();
}

// Запускаем "тикер" (10 раз в секунду)
setInterval(tick, 100);

/* ==========================================
   4. ТОРГОВАЯ ЛОГИКА
   ========================================== */
let balance = 10.00;
const LEVERAGE = 150;
let position = null; // { side, entry, notional, liq, lines:[] }

// UI Elements
const elBal = document.getElementById('ui-bal');
const elPnl = document.getElementById('ui-pnl');
const elActions = document.getElementById('action-area');
const elResetScreen = document.getElementById('reset-screen');

function openPos(side) {
    if(position || balance <= 0) return;

    const entry = currentPrice;
    const notional = balance * LEVERAGE;
    
    // Ликвидация очень близко (плечо 150)
    // Long Liq: Price * (1 - 1/150)
    let liqPrice = 0;
    if(side === 'long') liqPrice = entry * (1 - 0.9/LEVERAGE); // Чуть строже (0.9)
    else liqPrice = entry * (1 + 0.9/LEVERAGE);

    position = {
        side, entry, notional, liq: liqPrice, lines: []
    };

    // Линии на графике
    position.lines.push(chart.addPriceLine({
        price: entry, color: '#f0b90b', lineWidth: 2, lineStyle: 2, title: 'ENTRY'
    }));
    position.lines.push(chart.addPriceLine({
        price: liqPrice, color: '#e04b4b', lineWidth: 2, lineStyle: 0, title: 'LIQ'
    }));

    renderControls();
}

function closePos() {
    if(!position) return;
    const pnl = calcPnL();
    balance += pnl;
    if(balance < 0) balance = 0;

    clearPosition();
    elBal.textContent = balance.toFixed(2);
    renderControls();
}

function calcPnL() {
    if(!position) return 0;
    const diff = (currentPrice - position.entry) / position.entry;
    return position.side === 'long' 
        ? position.notional * diff 
        : position.notional * -diff;
}

function updateTradingLogic() {
    if(!position) return;

    const pnl = calcPnL();
    const equity = balance + pnl;

    // UI PnL
    elPnl.textContent = (pnl > 0 ? "+" : "") + pnl.toFixed(2);
    elPnl.className = "stat-val " + (pnl >= 0 ? "pnl-pos" : "pnl-neg");

    // LIQUIDATION CHECK
    let isLiq = false;
    if(position.side === 'long' && currentPrice <= position.liq) isLiq = true;
    if(position.side === 'short' && currentPrice >= position.liq) isLiq = true;
    if(equity <= 0) isLiq = true;

    if(isLiq) {
        balance = 0;
        clearPosition();
        elBal.textContent = "0.00";
        elPnl.textContent = "0.00";
        elResetScreen.style.display = 'flex'; // Показываем экран смерти
    }
}

function clearPosition() {
    if(position) {
        position.lines.forEach(l => chart.removePriceLine(l));
    }
    position = null;
    elPnl.textContent = "0.00";
    elPnl.className = "stat-val pnl-neu";
}

function renderControls() {
    if(!position) {
        elActions.innerHTML = `
            <button class="btn btn-long" onclick="openPos('long')">LONG</button>
            <button class="btn btn-short" onclick="openPos('short')">SHORT</button>
        `;
    } else if (position.side === 'long') {
        elActions.innerHTML = `
            <button class="btn" disabled>ENTRY ${position.entry.toFixed(0)}</button>
            <button class="btn btn-short" onclick="closePos()">CLOSE</button>
        `;
    } else {
        elActions.innerHTML = `
            <button class="btn btn-long" onclick="closePos()">CLOSE</button>
            <button class="btn" disabled>ENTRY ${position.entry.toFixed(0)}</button>
        `;
    }
}

function resetGame() {
    balance = 10.00;
    elBal.textContent = "10.00";
    elResetScreen.style.display = 'none';
    
    // Пересоздаем график чтобы было ощущение нового начала
    initHistory();
    chart.timeScale().fitContent();
    renderControls();
}

// Запуск
initHistory();
renderControls();

</script>
</body>
</html>
