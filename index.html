<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Chaos Trading Sim v2</title>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
/* ===== 1. ОСНОВНОЙ СТИЛЬ ===== */
body {
    margin: 0;
    background: #121417;
    color: #e6e6e6;
    font-family: -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif;
    overflow: hidden; /* Блокируем скролл */
    height: 100vh;
    display: flex;
    flex-direction: column;
}

.wrapper {
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
}

/* ===== 2. ШАПКА ===== */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-shrink: 0;
}
.title { font-size: 18px; font-weight: 800; color: #fff; }
.sub { font-size: 12px; color: #6b7280; margin-top: 2px; }
.live-badge { 
    background: #1fc77b; color: #000; padding: 2px 6px; 
    border-radius: 4px; font-size: 10px; font-weight: 700; vertical-align: middle;
}

/* ===== 3. ГРАФИК ===== */
#chart-area {
    flex: 1;
    width: 100%;
    min-height: 0;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    border: 1px solid #1f2937;
    margin-bottom: 15px;
}
#price { width: 100%; height: 100%; }

/* Окно ликвидации */
.reset-overlay {
    position: absolute; top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.85);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.btn-restart {
    padding: 15px 40px;
    background: #e04b4b; color: #fff;
    border: 0; border-radius: 30px;
    font-weight: 800; font-size: 18px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(224, 75, 75, 0.4);
}

/* ===== 4. ПАНЕЛЬ ТОРГОВЛИ ===== */
.trade-panel {
    background: #1e2228;
    border-radius: 16px;
    padding: 15px 20px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    flex-shrink: 0;
}

.stats-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
}

.stat-box { display: flex; flex-direction: column; }
.stat-label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: 600; }
.stat-val { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; font-variant-numeric: tabular-nums; }

.pnl-pos { color: #1fc77b; }
.pnl-neg { color: #e04b4b; }
.pnl-neu { color: #fff; }

.buttons-row { display: flex; gap: 12px; }

.btn {
    flex: 1;
    height: 54px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 800;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: transform 0.1s;
    cursor: pointer;
    line-height: 1.1;
}
.btn:active { transform: scale(0.96); }

/* Стили кнопок */
.btn-green { background: #1fc77b; color: #000; box-shadow: 0 4px 12px rgba(31, 199, 123, 0.2); }
.btn-red { background: #e04b4b; color: #fff; box-shadow: 0 4px 12px rgba(224, 75, 75, 0.2); }

/* Неактивная кнопка (показывает вход) */
.btn-disabled {
    background: #2a2d33 !important;
    color: #6b7280 !important;
    box-shadow: none !important;
    cursor: not-allowed;
    border: 1px solid #374151;
}
.btn-sub { font-size: 10px; font-weight: 600; opacity: 0.7; }

</style>
</head>

<body>

<div class="wrapper">
    <header>
        <div>
            <div class="title">BTC/USDT <span class="live-badge">SIM</span></div>
            <div class="sub">Chaos Engine • x150 Leverage</div>
        </div>
    </header>

    <div id="chart-area">
        <div id="price"></div>
        <div class="reset-overlay" id="reset-screen">
            <h2 style="color:#e04b4b; margin-bottom:10px; font-size:28px;">LIQUIDATED</h2>
            <div style="color:#ccc; margin-bottom:20px;">You lost everything.</div>
            <button class="btn-restart" onclick="resetGame()">TRY AGAIN</button>
        </div>
    </div>

    <div class="trade-panel">
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-label">Balance</span>
                <span class="stat-val" id="ui-bal">10.00</span>
            </div>
            <div class="stat-box" style="align-items: flex-end;">
                <span class="stat-label">PnL (USDT)</span>
                <span class="stat-val pnl-neu" id="ui-pnl">0.00</span>
            </div>
        </div>

        <div class="buttons-row" id="action-area">
            </div>
    </div>
</div>

<script>
/* ==========================================
   1. СИСТЕМНЫЕ НАСТРОЙКИ
   ========================================== */
document.addEventListener('gesturestart', function(e) { e.preventDefault(); });

/* ==========================================
   2. ГРАФИК (Lightweight Charts)
   ========================================== */
const chart = LightweightCharts.createChart(document.getElementById('price'), {
    layout: { background: { color: '#121417' }, textColor: '#9ca3af' },
    grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } },
    timeScale: { timeVisible: true, secondsVisible: true, borderColor: '#1f2937' },
    crosshair: { mode: 0 },
    handleScroll: { vertTouchDrag: false, horzTouchDrag: true },
    handleScale: { pinch: true, axisPressedMouseMove: true },
});

const candleSeries = chart.addCandlestickSeries({
    upColor: '#1fc77b', downColor: '#e04b4b',
    borderUpColor: '#1fc77b', borderDownColor: '#e04b4b',
    wickUpColor: '#1fc77b', wickDownColor: '#e04b4b'
});

new ResizeObserver(e => {
    const r = e[0].contentRect;
    chart.resize(r.width, r.height);
}).observe(document.getElementById('chart-area'));

/* ==========================================
   3. ГЕНЕРАТОР ХАОСА (РЫНОК)
   ========================================== */
let currentPrice = 95000.00;
let candleInterval = 60; // seconds
let nextCandleTime = 0;
let currentCandle = null;
let momentum = 0;

// Инициализация истории
function initMarket() {
    const data = [];
    let time = Math.floor(Date.now()/1000) - (100*60);
    let price = currentPrice;
    
    for(let i=0; i<100; i++){
        const open = price;
        const change = (Math.random()-0.5)*150;
        const close = open + change;
        const high = Math.max(open, close) + Math.random()*30;
        const low = Math.min(open, close) - Math.random()*30;
        data.push({ time, open, high, low, close });
        price = close;
        time += 60;
    }
    currentPrice = price;
    candleSeries.setData(data);
    
    nextCandleTime = time + 60;
    currentCandle = { time: nextCandleTime, open: price, high: price, low: price, close: price };
}

function tick() {
    const now = Math.floor(Date.now()/1000);
    
    // Новая свеча
    if(now >= nextCandleTime) {
        nextCandleTime += 60;
        currentCandle = { 
            time: nextCandleTime, 
            open: currentPrice, high: currentPrice, low: currentPrice, close: currentPrice 
        };
    }

    // Движение цены
    let delta = (Math.random() - 0.5) * 25; // Шум
    momentum = momentum * 0.9 + delta * 0.1; // Инерция
    
    // Всплески волатильности (Китовые движения)
    if(Math.random() < 0.05) delta += (Math.random()-0.5) * 200;

    currentPrice += delta + momentum;

    // Обновляем свечу
    currentCandle.close = currentPrice;
    currentCandle.high = Math.max(currentCandle.high, currentPrice);
    currentCandle.low = Math.min(currentCandle.low, currentPrice);
    
    candleSeries.update(currentCandle);
    updateGameLoop();
}

setInterval(tick, 100);

/* ==========================================
   4. ТОРГОВАЯ МЕХАНИКА
   ========================================== */
let balance = 10.00;
const LEVERAGE = 150;
let position = null; // { side, entry, notional, liq, lines:[] }

const elBal = document.getElementById('ui-bal');
const elPnl = document.getElementById('ui-pnl');
const elActions = document.getElementById('action-area');
const elReset = document.getElementById('reset-screen');

function openPos(side) {
    if(position || balance <= 0) return;

    const entry = currentPrice;
    const notional = balance * LEVERAGE;
    
    // Расчет ликвидации
    // Long: Liq < Entry. Short: Liq > Entry.
    const liqDist = entry * (1/LEVERAGE);
    const liq = side === 'long' 
        ? entry - (liqDist * 0.9) 
        : entry + (liqDist * 0.9);

    position = { side, entry, notional, liq, lines: [] };

    // Линии
    position.lines.push(chart.addPriceLine({
        price: entry, color: '#f0b90b', lineWidth: 2, lineStyle: 2, title: 'ENTRY'
    }));
    position.lines.push(chart.addPriceLine({
        price: liq, color: '#e04b4b', lineWidth: 2, lineStyle: 0, title: 'LIQ'
    }));

    renderControls();
}

function closePos() {
    if(!position) return;
    
    // 1. Считаем PnL
    const pnl = calcPnL();
    
    // 2. Обновляем баланс (parseFloat для надежности)
    balance = parseFloat(balance) + parseFloat(pnl);
    if(balance < 0) balance = 0;
    
    // 3. Чистим
    if(position.lines) position.lines.forEach(l => chart.removePriceLine(l));
    position = null;
    
    // 4. Обновляем UI
    elBal.textContent = balance.toFixed(2);
    elPnl.textContent = "0.00";
    elPnl.className = "stat-val pnl-neu";
    
    renderControls();
}

function calcPnL() {
    if(!position) return 0;
    const diff = (currentPrice - position.entry) / position.entry;
    return position.side === 'long' 
        ? position.notional * diff 
        : position.notional * (-diff);
}

function updateGameLoop() {
    if(!position) return;

    const pnl = calcPnL();
    const equity = balance + pnl;

    // UI PnL
    elPnl.textContent = (pnl > 0 ? "+" : "") + pnl.toFixed(2);
    elPnl.className = "stat-val " + (pnl >= 0 ? "pnl-pos" : "pnl-neg");

    // Проверка ликвидации
    let isLiq = false;
    if(position.side === 'long' && currentPrice <= position.liq) isLiq = true;
    if(position.side === 'short' && currentPrice >= position.liq) isLiq = true;
    if(equity <= 0) isLiq = true;

    if(isLiq) {
        balance = 0;
        if(position.lines) position.lines.forEach(l => chart.removePriceLine(l));
        position = null;
        elBal.textContent = "0.00";
        elPnl.textContent = "0.00";
        elReset.style.display = 'flex';
    }
}

function renderControls() {
    // 1. Нет позиции
    if(!position) {
        elActions.innerHTML = `
            <button class="btn btn-green" onclick="openPos('long')">
                LONG
                <span class="btn-sub">BUY</span>
            </button>
            <button class="btn btn-red" onclick="openPos('short')">
                SHORT
                <span class="btn-sub">SELL</span>
            </button>
        `;
    } 
    // 2. Есть LONG позиция
    else if(position.side === 'long') {
        elActions.innerHTML = `
            <button class="btn btn-disabled" disabled>
                LONG
                <span class="btn-sub">@${position.entry.toFixed(0)}</span>
            </button>
            <button class="btn btn-red" onclick="closePos()">
                CLOSE LONG
                <span class="btn-sub">SELL TO CLOSE</span>
            </button>
        `;
    } 
    // 3. Есть SHORT позиция
    else {
        elActions.innerHTML = `
            <button class="btn btn-green" onclick="closePos()">
                CLOSE SHORT
                <span class="btn-sub">BUY TO CLOSE</span>
            </button>
            <button class="btn btn-disabled" disabled>
                SHORT
                <span class="btn-sub">@${position.entry.toFixed(0)}</span>
            </button>
        `;
    }
}

function resetGame() {
    balance = 10.00;
    elBal.textContent = "10.00";
    elReset.style.display = 'none';
    initMarket(); // Перезапуск рынка
    chart.timeScale().fitContent();
    renderControls();
}

// Запуск
initMarket();
renderControls();

</script>
</body>
</html>
