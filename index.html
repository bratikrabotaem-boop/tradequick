<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>BTC-USDT · Pro Simulator</title>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
/* ===== BASIC STYLES ===== */
body { margin:0; background:#121417; color:#e6e6e6; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
.wrapper { max-width:1100px; margin:0 auto; padding:10px; display:flex; flex-direction:column; height:100vh; box-sizing:border-box; }

/* ===== HEADER ===== */
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.title-box { line-height:1.2; }
.title { font-size:16px; font-weight:700; color:#fff; }
.sub { font-size:12px; color:#6b7280; }

.tf-buttons { display:flex; gap:5px; background:#1e2228; padding:3px; border-radius:6px; }
.tf-buttons button { background:transparent; border:0; color:#888; padding:4px 10px; border-radius:4px; font-size:12px; cursor:pointer; font-weight:600; transition:0.2s; }
.tf-buttons button:hover { color:#ccc; }
.tf-buttons button.active { background:#363a45; color:#fff; }

/* ===== CHARTS ===== */
#charts-container { flex:1; display:flex; flex-direction:column; min-height:0; }
#price { flex:3; width:100%; }
#volume { flex:1; width:100%; margin-top:5px; }

/* ===== TRADING PANEL ===== */
.trade-panel {
  margin-top:10px;
  background:#1e2228;
  padding:15px;
  border-radius:8px;
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  gap:15px;
}

.stats { display:flex; gap:20px; font-size:14px; }
.stat-item { display:flex; flex-direction:column; }
.stat-label { font-size:10px; color:#888; text-transform:uppercase; letter-spacing:0.5px; }
.stat-val { font-weight:700; font-size:16px; font-variant-numeric: tabular-nums; }

.actions { display:flex; gap:10px; flex:1; justify-content: flex-end;}
.btn {
  border:0; border-radius:4px; padding:0 20px; height:45px; font-weight:700; cursor:pointer; font-size:14px; color:#000; transition:opacity 0.2s;
  display:flex; align-items:center; justify-content:center; flex:1; max-width: 160px;
}
.btn:active { opacity:0.8; }
/* Disabled state specifically for active positions */
.btn:disabled { opacity:0.5; cursor:not-allowed; color: #fff; background: #2a2d33 !important; border: 1px solid #444; }

.btn-buy { background:#1fc77b; } /* Green */
.btn-sell { background:#e04b4b; } /* Red */

.btn-reset { background:transparent; border:1px solid #444; color:#888; height:30px; font-size:11px; width: auto; flex: none;}

/* PnL Colors */
.pnl-pos { color:#1fc77b; }
.pnl-neg { color:#e04b4b; }
.pnl-neu { color:#ccc; }

/* Mobile Tweaks */
@media (max-width: 600px) {
  .trade-panel { flex-direction:column; align-items:stretch; }
  .stats { justify-content:space-around; margin-bottom:10px; }
  .actions { width: 100%; }
}
</style>
</head>

<body>
<div class="wrapper">
  
  <header>
    <div class="title-box">
      <div class="title">BTC/USDT</div>
      <div class="sub">Net Volume • x150 Leverage</div>
    </div>
    <div class="tf-buttons">
      <button onclick="setTF('15m')">15M</button>
      <button onclick="setTF('5m')">5M</button>
      <button onclick="setTF('1m')" class="active">1M</button>
    </div>
  </header>

  <div id="charts-container">
    <div id="price"></div>
    <div id="volume"></div>
  </div>

  <div class="trade-panel">
    <div class="stats">
      <div class="stat-item">
        <span class="stat-label">Balance</span>
        <span class="stat-val" id="ui-bal">10.00</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">PnL (USDT)</span>
        <span class="stat-val pnl-neu" id="ui-pnl">0.00</span>
      </div>
    </div>

    <div class="actions" id="action-buttons">
      </div>
    
    <button class="btn btn-reset" onclick="resetGame()" style="display:none;" id="btn-reset">RESET</button>
  </div>

</div>

<script>
/* ===== 1. UTILS & CONFIG ===== */
['gesturestart','gesturechange','gestureend'].forEach(e=>{
  document.addEventListener(e,ev=>ev.preventDefault(),{passive:false});
});

let INTERVAL = '1m';
let ws = null;
let sessionId = 0;
let lastPrice = 0;

/* ===== 2. CHARTS SETUP ===== */
const commonOpts = {
  layout:{ background:{color:'#121417'}, textColor:'#6b7280' },
  grid:{ vertLines:{color:'#1e2228'}, horzLines:{color:'#1e2228'} },
  timeScale:{ timeVisible:true, secondsVisible:false, borderColor:'#1e2228' },
  crosshair: { mode: 1 },
};

const priceChart = LightweightCharts.createChart(document.getElementById('price'), {
  ...commonOpts,
  rightPriceScale:{ borderVisible:false },
});
const candles = priceChart.addCandlestickSeries({
  upColor:'#1fc77b', downColor:'#e04b4b',
  borderUpColor:'#1fc77b', borderDownColor:'#e04b4b',
  wickUpColor:'#1fc77b', wickDownColor:'#e04b4b'
});

const volumeChart = LightweightCharts.createChart(document.getElementById('volume'), {
  ...commonOpts,
  rightPriceScale:{ borderVisible:false },
});
const volumeSeries = volumeChart.addHistogramSeries({
  base:0, priceFormat:{type:'volume'}
});

// Resize Logic
const resizeObserver = new ResizeObserver(entries => {
  for (let entry of entries) {
    if(entry.target.id === 'price') priceChart.resize(entry.contentRect.width, entry.contentRect.height);
    if(entry.target.id === 'volume') volumeChart.resize(entry.contentRect.width, entry.contentRect.height);
  }
});
resizeObserver.observe(document.getElementById('price'));
resizeObserver.observe(document.getElementById('volume'));

// Sync
const sync = (a, b) => {
  let s = false;
  a.timeScale().subscribeVisibleLogicalRangeChange(r => {
    if(!s && r) { s=true; b.timeScale().setVisibleLogicalRange(r); s=false; }
  });
};
sync(priceChart, volumeChart);
sync(volumeChart, priceChart);

/* ===== 3. DATA LOADING ===== */
async function loadData() {
  sessionId++;
  const currentSession = sessionId;
  if(ws) { ws.close(); ws = null; }

  try {
    const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${INTERVAL}&limit=300`);
    const d = await r.json();
    const cData = [], vData = [];
    
    d.forEach(k => {
      const t = k[0]/1000;
      const o=+k[1], h=+k[2], l=+k[3], c=+k[4];
      cData.push({ time:t, open:o, high:h, low:l, close:c });
      const net = 2 * (+k[10]) - (+k[7]); 
      vData.push({ time:t, value:net, color: net>=0 ? '#1fc77b' : '#e04b4b' });
    });

    candles.setData(cData);
    volumeSeries.setData(vData);
    if(cData.length) lastPrice = cData[cData.length-1].close;
    priceChart.timeScale().fitContent();
    startStream(currentSession);
  } catch (e) {
    console.error(e);
    alert("Error connecting to Binance API");
  }
}

function startStream(sess) {
  ws = new WebSocket(`wss://stream.binance.com:9443/ws/btcusdt@kline_${INTERVAL}`);
  ws.onmessage = (e) => {
    if(sess !== sessionId) return;
    const msg = JSON.parse(e.data);
    const k = msg.k;
    const t = Math.floor(k.t / 1000);
    const c = +k.c;
    lastPrice = c;

    candles.update({ time:t, open:+k.o, high:+k.h, low:+k.l, close:c });
    const net = 2 * (+k.Q) - (+k.q);
    volumeSeries.update({ time:t, value:net, color: net>=0 ? '#1fc77b' : '#e04b4b' });

    updateGameLoop();
  };
}

function setTF(tf) {
  if(INTERVAL === tf) return;
  INTERVAL = tf;
  document.querySelectorAll('.tf-buttons button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  loadData();
}

/* ===== 4. TRADING ENGINE ===== */
let balance = 10.00;
const LEVERAGE = 150;
let position = null; // { side, entry, notional, liqPrice, lines:[] }

const uiBal = document.getElementById('ui-bal');
const uiPnl = document.getElementById('ui-pnl');
const actionsDiv = document.getElementById('action-buttons');
const resetBtn = document.getElementById('btn-reset');

function openPos(side) {
  if(position || balance < 1) return;
  
  const margin = balance;
  const entry = lastPrice;
  const notional = margin * LEVERAGE;
  
  // Liq Logic
  const liqPrice = side === 'long' 
    ? entry * (1 - 0.90/LEVERAGE) // Даем чуть больше воздуха (90% маржи)
    : entry * (1 + 0.90/LEVERAGE);

  position = { side, entry, notional, liqPrice, lines: [] };

  // --- ЛИНИИ (ИЗМЕНЕНИЯ ЗДЕСЬ) ---
  
  // 1. Зеленая пунктирная линия входа
  position.lines.push(priceChart.addPriceLine({
    price: entry,
    color: '#1fc77b', 
    lineWidth: 2,
    lineStyle: LightweightCharts.LineStyle.Dotted, // Пунктир
    axisLabelVisible: true,
    title: `ENTRY`
  }));

  // 2. Красная пунктирная линия ликвидации
  position.lines.push(priceChart.addPriceLine({
    price: liqPrice,
    color: '#e04b4b',
    lineWidth: 2,
    lineStyle: LightweightCharts.LineStyle.Dotted, // Пунктир
    axisLabelVisible: true,
    title: `LIQ`
  }));

  renderControls();
}

function closePos() {
  if(!position) return;
  const pnl = calcPnL();
  balance += pnl;
  if(balance < 0) balance = 0;

  clearPosition();
  uiBal.textContent = balance.toFixed(2);
}

function clearPosition() {
  if(position) {
    position.lines.forEach(l => priceChart.removePriceLine(l));
  }
  position = null;
  uiPnl.textContent = "0.00";
  uiPnl.className = "stat-val pnl-neu";
  renderControls();
}

function calcPnL() {
  if(!position) return 0;
  const diff = (lastPrice - position.entry) / position.entry;
  return position.side === 'long' ? position.notional * diff : position.notional * -diff;
}

function updateGameLoop() {
  if(!position) return;
  const pnl = calcPnL();
  const equity = balance + pnl;
  
  uiPnl.textContent = (pnl > 0 ? "+" : "") + pnl.toFixed(2);
  uiPnl.className = "stat-val " + (pnl >= 0 ? "pnl-pos" : "pnl-neg");
  
  // Check Liquidation
  let isLiq = false;
  if (position.side === 'long' && lastPrice <= position.liqPrice) isLiq = true;
  if (position.side === 'short' && lastPrice >= position.liqPrice) isLiq = true;
  
  if (isLiq || equity <= 0) {
    balance = 0;
    uiBal.textContent = "0.00";
    alert("LIQUIDATED!");
    clearPosition();
  }
}

function renderControls() {
  if(balance <= 0.1 && !position) {
    resetBtn.style.display = 'block';
    actionsDiv.innerHTML = `<button class="btn" disabled>GAME OVER</button>`;
    return;
  }
  resetBtn.style.display = 'none';

  // --- ЛОГИКА КНОПОК (ИЗМЕНЕНИЯ ЗДЕСЬ) ---
  if(!position) {
    // Нет позиции: Обычные кнопки
    actionsDiv.innerHTML = `
      <button class="btn btn-buy" onclick="openPos('long')">LONG</button>
      <button class="btn btn-sell" onclick="openPos('short')">SHORT</button>
    `;
  } else if (position.side === 'long') {
    // Есть LONG:
    // Кнопка BUY -> Показывает вход (неактивна)
    // Кнопка SELL -> Работает как Close
    actionsDiv.innerHTML = `
      <button class="btn" disabled>LONG @${position.entry.toFixed(1)}</button>
      <button class="btn btn-sell" onclick="closePos()">CLOSE LONG</button>
    `;
  } else if (position.side === 'short') {
    // Есть SHORT:
    // Кнопка BUY -> Работает как Close
    // Кнопка SELL -> Показывает вход (неактивна)
    actionsDiv.innerHTML = `
      <button class="btn btn-buy" onclick="closePos()">CLOSE SHORT</button>
      <button class="btn" disabled>SHORT @${position.entry.toFixed(1)}</button>
    `;
  }
}

function resetGame() {
  balance = 10.00;
  uiBal.textContent = "10.00";
  renderControls();
}

/* ===== INIT ===== */
loadData();
renderControls();
</script>
</body>
</html>
